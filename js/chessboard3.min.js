!function(){"use strict";function o(e,o,t){C.push({onUpdate:e,onComplete:o,duration:t,started:window.performance.now()}),e(0)}function t(){var e=[];C.forEach(function(o){var t=window.performance.now(),n=(t-o.started)/o.duration;1>n?(o.onUpdate(n),e.push(o)):(o.onUpdate(1),o.onComplete())}),C=e}function n(){try{var e=document.createElement("canvas");return!(!window.hasOwnProperty("WebGLRenderingContext")||!window.WebGLRenderingContext||!e.getContext("webgl")&&!e.getContext("experimental-webgl"))}catch(o){return!1}}function r(e){return JSON.parse(JSON.stringify(e))}function i(e){if("string"!=typeof e)return!1;var o=e.split("-");return 2!==o.length?!1:a(o[0])&&a(o[1])}function a(e){return s(e)||p(e)}function s(e){return"string"!=typeof e?!1:-1!==e.search(/^[a-h][1-8]$/)}function p(e){return"string"!=typeof e?!1:-1!==e.search(/^s[bw][1-6]$/)}function c(e){return"string"!=typeof e?!1:-1!==e.search(/^[bw][KQRNBP]$/)}function l(e){if("string"!=typeof e)return!1;e=e.replace(/ .+$/,"");var o=e.split("/");if(8!==o.length)return!1;for(var t=0;8>t;t++)if(""===o[t]||o[t].length>8||-1!==o[t].search(/[^kqrbnpKQRNBP1-8]/))return!1;return!0}function u(e){if("object"!=typeof e)return!1;for(var o in e)if(e.hasOwnProperty(o)===!0&&(a(o)!==!0||c(e[o])!==!0))return!1;return!0}function f(e){return e.toLowerCase()===e?"b"+e.toUpperCase():"w"+e.toUpperCase()}function d(e){var o=e.split("");return"w"===o[0]?o[1].toUpperCase():o[1].toLowerCase()}function h(e){if(l(e)!==!0)return!1;e=e.replace(/ .+$/,"");for(var o=e.split("/"),t={},n=8,r=0;8>r;r++){for(var i=o[r].split(""),a=0,s=0;s<i.length;s++)if(-1!==i[s].search(/[1-8]/))a+=parseInt(i[s],10);else{var p=E[a]+n;t[p]=f(i[s]),a++}n--}return t}function w(e){if(u(e)!==!0)return!1;for(var o="",t=8,n=0;8>n;n++){for(var r=0;8>r;r++){var i=E[r]+t;o+=e.hasOwnProperty(i)===!0?d(e[i]):"1"}7!==n&&(o+="/"),t--}return o=o.replace(/11111111/g,"8"),o=o.replace(/1111111/g,"7"),o=o.replace(/111111/g,"6"),o=o.replace(/11111/g,"5"),o=o.replace(/1111/g,"4"),o=o.replace(/111/g,"3"),o=o.replace(/11/g,"2")}var v=71,y="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR",E="abcdefgh".split(""),m=[[50,40,30],[-50,0,-30]],g=2,P=Math.PI/4,b=18.25,S={sw1:"wK",sw2:"wQ",sw3:"wR",sw4:"wB",sw5:"wN",sw6:"wP",sb1:"bK",sb2:"bQ",sb3:"bR",sb4:"bB",sb5:"bN",sb6:"bP"},O=500,x=.75,C=[];window.ChessBoard3=window.ChessBoard3||function(a,c){function f(e,o,t){c.showErrors;if(c.hasOwnProperty("showErrors")===!0&&c.showErrors!==!1){var n="ChessBoard3 Error "+e+": "+o;return c.hasOwnProperty("showErrors")&&"console"===c.showErrors&&"object"==typeof console&&"function"==typeof console.log?(console.log(n),void(arguments.length>=2&&console.log(t))):"alert"===c.showErrors?(t&&(n+="\n\n"+JSON.stringify(t)),void window.alert(n)):void("function"==typeof c.showErrors&&c.showErrors.call(e,o,t))}}function d(){if(void 0===THREE||void 0===THREE.REVISION||isNaN(parseInt(THREE.REVISION))||parseInt(THREE.REVISION)<v)return console.log("ChessBoard3 Error 3006: Unable to find three.js revision 71 or greater. \n\nExiting..."),!1;if(!n())return window.alert("ChessBoard3 Error 3001: WebGL is not enabled.\n\nExiting..."),!1;if("string"==typeof a){if(""===a)return window.alert("ChessBoard3 Error 1001: The first argument to ChessBoard3() cannot be an empty string.\n\nExiting..."),!1;var e=document.getElementById(a);if(!e)return window.alert('ChessBoard Error 1002: Element with id "'+a+'"does not exist in the DOM.\n\nExiting...'),!1;me=e}else if(me=a,-1!==me.length)return window.alert("ChessBoard3 Error 1003: The first argument to ChessBoard3() must be an ID or a single DOM node.\n\nExiting..."),!1;return!0}function C(e){return"fast"===e||"slow"===e?!0:parseInt(e,10)+""!=e+""?!1:e>=0}function R(){return("string"==typeof c||u(c))&&(c={position:c}),"black"!==c.orientation&&(c.orientation="white"),$e=c.orientation,c.showNotation!==!1&&(c.showNotation=!0,(c.hasOwnProperty("fontData")!==!0||"string"!=typeof c.fontData&&"function"!=typeof c.fontData)&&(c.fontData="assets/fonts/helvetiker_regular.typeface.json")),c.draggable!==!0&&(c.draggable=!1),"trash"!==c.dropOffBoard&&(c.dropOffBoard="snapback"),c.sparePieces!==!0&&(c.sparePieces=!1),c.sparePieces===!0&&(c.draggable=!0),(c.hasOwnProperty("pieceSet")!==!0||"string"!=typeof c.pieceSet&&"function"!=typeof c.pieceSet)&&(c.pieceSet="assets/chesspieces/iconic/{piece}.json"),c.rotateControls!==!1&&(c.rotateControls=!0),c.zoomControls!==!0&&(c.zoomControls=!1),c.hasOwnProperty("appearSpeed")!==!0||C(c.appearSpeed)!==!0?c.appearSpeed=200:c.hasOwnProperty("appearSpeed")&&("slow"===c.appearSpeed?c.appearSpeed=400:"fast"===c.appearSpeed&&(c.appearSpeed=100)),c.hasOwnProperty("moveSpeed")!==!0||C(c.moveSpeed)!==!0?c.moveSpeed=200:c.hasOwnProperty("moveSpeed")&&("slow"===c.moveSpeed?c.moveSpeed=400:"fast"===c.moveSpeed&&(c.moveSpeed=100)),c.hasOwnProperty("snapbackSpeed")!==!0||C(c.snapbackSpeed)!==!0?c.snapbackSpeed=50:c.hasOwnProperty("snapbackSpeed")&&("slow"===c.snapbackSpeed?c.snapbackSpeed=100:"fast"===c.snapbackSpeed&&(c.snapbackSpeed=25)),c.hasOwnProperty("snapSpeed")!==!0||C(c.snapSpeed)!==!0?c.snapSpeed=25:c.hasOwnProperty("snapSpeed")&&("slow"===c.snapSpeed?c.snapSpeed=50:"fast"===c.snapSpeed&&(c.snapSpeed=10)),c.hasOwnProperty("trashSpeed")!==!0||C(c.trashSpeed)!==!0?c.trashSpeed=100:c.hasOwnProperty("trashSpeed")&&("slow"===c.trashSpeed?c.trashSpeed=200:"fast"===c.trashSpeed&&(c.trashSpeed=50)),c.hasOwnProperty("position")===!0&&("start"===c.position?Fe=r(xe):l(c.position)===!0?Fe=h(c.position):u(c.position)===!0?Fe=r(c.position):f(7263,"Invalid value passed to config.position.",c.position)),!0}function z(){"black"!==c.orientation&&(c.orientation="white"),ge=new THREE.WebGLRenderer({alpha:!0,preserveDrawingBuffer:!0,antialias:!0,transparent:!0});var e;e=c.hasOwnProperty("backgroundColor")&&"number"==typeof c.backgroundColor?c.backgroundColor:12303291,ge.setClearColor(e,1),ge.setSize(me.clientWidth,Math.round(me.clientWidth*x)),Pe=new THREE.Scene,Se=new THREE.PerspectiveCamera(60,me.clientWidth/me.clientHeight,.1,1e3),Se.aspectRatio=x,c.sparePieces===!1&&(ze.multiplyScalar(.9),Me.multiplyScalar(.9)),"white"===c.orientation?Se.position.set(ze.x,ze.y,ze.z):"black"===c.orientation&&Se.position.set(Me.x,Me.y,Me.z),Se.lookAt(new THREE.Vector3(0,-3,0)),Pe.add(Se),ge.domElement.addEventListener("mousedown",de,!0),ge.domElement.addEventListener("mousemove",he,!0),ge.domElement.addEventListener("mouseup",we,!0),"ontouchstart"in document.documentElement&&(ge.domElement.addEventListener("touchstart",function(e){de(e,!0)},!0),ge.domElement.addEventListener("touchmove",function(e){he(e,!0)},!0),ge.domElement.addEventListener("touchend",we,!0)),(c.rotateControls||c.zoomControls)&&void 0!==THREE.OrbitControls&&(Oe=new THREE.OrbitControls(Se,ge.domElement,ge.domElement),Oe.noPan=!0,c.rotateControls?(Oe.minPolarAngle=Math.PI/2*.1,Oe.maxPolarAngle=Math.PI/2*.8):Oe.noRotate=!0,c.zoomControls?(Oe.minDistance=12,Oe.maxDistance=22):Oe.noZoom=!0,Oe.target.y=-3,Oe.enabled=!0)}function M(e){Qe=!0;var t=Se.position,n=t.y,r=e.y,i=Math.sqrt(Math.pow(t.x,2)+Math.pow(t.z,2)),a=Math.sqrt(Math.pow(e.x,2)+Math.pow(e.z,2)),s=Math.acos(t.x/i),p=Math.acos(e.x/a);t.z<0&&(s=-s),e.z<0&&(p=-p),(p-s>=Math.PI||s-p>Math.PI)&&(p>s?p-=2*Math.PI:p+=2*Math.PI);var c=function(){Se.position.set(e.x,e.y,e.z),Se.lookAt(new THREE.Vector3(0,-3,0)),Qe=!1,Je=!0};o(function(e){var o=s+e*(p-s),t=i+e*(a-i);Se.position.set(t*Math.cos(o),n+e*(r-n),t*Math.sin(o)),Se.lookAt(new THREE.Vector3(0,-3,0))},c,1e3)}function T(e,o){var t,n=_(e),r=o.charAt(0),i=o.charAt(1);"w"===r?t=He.clone():"b"===r&&(t=ke.clone());var a,s;return a=Ke[i],s=new THREE.Mesh(a,t),s.position.x=n.x,s.position.z=n.z,"w"===r&&(s.rotation.y=Math.PI),s.castShadow=!0,s}function H(){var o=new THREE.FontLoader,t=null;"function"==typeof c.fontData?t=c.fontData():"string"==typeof c.fontData&&(t=c.fontData),null===t&&(c.showNotation=!1,f(2354,e)),o.load(t,function(e){var o={font:e,size:.5,height:0,weight:"normal",style:"normal",curveSegments:12,steps:1,bevelEnabled:!1,material:0,extrudeMaterial:1};be=[];for(var t,n,r="abcdefgh".split(""),i=0;8>i;i++)t=new THREE.TextGeometry(r[i],o),t.computeBoundingBox(),t.computeVertexNormals(),n=new THREE.Mesh(t,_e),n.position.x=2*i-7-o.size/2,n.position.y=-.5,n.position.z=-9,be.push(n),Pe.add(n),n=new THREE.Mesh(t,je),n.position.x=2*i-7-o.size/2,n.position.y=-.5,n.position.z=9,be.push(n),Pe.add(n);var a="12345678".split("");for(i=0;8>i;i++)t=new THREE.TextGeometry(a[i],o),n=new THREE.Mesh(t,Le),n.position.x=-9,n.position.y=-.5,n.position.z=-7-o.size/2+2*(7-i),be.push(n),Pe.add(n),n=new THREE.Mesh(t,Ae),n.position.x=9,n.position.y=-.5,n.position.z=-7-o.size/2+2*(7-i),be.push(n),Pe.add(n)})}function B(){var e;for(e=0;8>e;e++)for(var o=3.5*g-g*e,t=0;8>t;t++){var n=g*t-3.5*g,r="abcdefgh".charAt(t)+(e+1),i=e%2===0^t%2===0?Ue:Ge,a=new THREE.BoxGeometry(2,.5,2),s=new THREE.Mesh(a,i.clone());s.position.set(n,-.25,o),a.computeFaceNormals(),a.computeVertexNormals(),s.receiveShadow=!0,Xe[r]=s.id,s.tag=r,Pe.add(s)}c.showNotation&&H();for(var p=0;p<m.length;p++){var l=new THREE.SpotLight(11184810),u=m[p];l.position.set(u[0],u[1],u[2]),l.target=new THREE.Object3D,0===p&&(l.castShadow=!0,l.shadowBias=1e-4,l.shadowDarkness=.2,l.shadowMapWidth=2048,l.shadowMapHeight=2048),Pe.add(l)}var f=new THREE.AmbientLight(5592405);Pe.add(f)}function I(){for(var e in Ye)if(Ye.hasOwnProperty(e)&&!p(e))if(Fe.hasOwnProperty(e)===!1)f(3701,"Square "+e+" in PIECE_MESH_IDS but not in CURRENT_POSITION");else if(!Pe.getObjectById(Ye[e])){f(3702,"Mesh not present on square "+e+", adding a replacement.");var o=T(e,Fe[e]);Pe.add(o),Ye[e]=o.id}for(e in Fe)Fe.hasOwnProperty(e)&&Ye.hasOwnProperty(e)===!1&&f(3703,"Square "+e+" in CURRENT_POSITION but not in PIECE_MESH_IDS")}function k(e,t,n){var r,i;if(Ye.hasOwnProperty(e)&&(i=Pe.getObjectById(Ye[e])),Xe.hasOwnProperty(t)&&(r=Pe.getObjectById(Xe[t])),p(e)&&(i=i.clone(),Pe.add(i)),r&&i){var a=i.position.x,l=i.position.z,u=r.position.x,f=r.position.z;o(function(e){i.position.x=a+e*(u-a),i.position.z=l+e*(f-l)},function(){Ye[t]=i.id,s(e)&&i.id===Ye[e]&&delete Ye[e],n()},c.moveSpeed)}}function q(e,t){if(Ye.hasOwnProperty(e)&&s(e)&&Ye.hasOwnProperty(e)){var n=Pe.getObjectById(Ye[e]);o(function(e){n.opacity=1-e},function(){Pe.remove(n),delete Ye[e],t()},c.trashSpeed)}}function N(e,t,n){var r=T(e,t);r.opacity=0,Pe.add(r),o(function(){r.opacity=this.t},function(){Ye[e]=r.id,n()},c.appearSpeed)}function D(e,o,t){function n(){a--,0===a&&(te(t),c.hasOwnProperty("moveEnd")&&"function"==typeof c.onMoveEnd&&c.onMoveEnd(r(o,r(t))),Je=!0,I(),Qe=!1)}if(0!==e.length){Qe=!0;var i,a=e.length;for(i=0;i<e.length;i++)"clear"===e[i].type&&s(e[i].square)&&Ye.hasOwnProperty(e[i].square)&&q(e[i].square,n);for(i=0;i<e.length;i++)"move"===e[i].type&&k(e[i].source,e[i].destination,n);for(i=0;i<e.length;i++)if("add"===e[i].type)if(c.sparePieces===!0)for(var p in S)S.hasOwnProperty(p)&&S[p]===e[i].piece&&k(p,e[i].square,n);else N(e[i].square,e[i].piece,n)}}function _(e){var o,t;if(p(e)){var n=e.charCodeAt(2)-"1".charCodeAt(0);o=g*(4*n-10)/3,"w"==e.charAt(1)?t=5*g:"b"==e.charAt(1)&&(t=-5*g)}else s(e)&&(o=g*(e.charCodeAt(0)-"a".charCodeAt(0))-3.5*g,t=3.5*g-g*(e.charCodeAt(1)-"1".charCodeAt(0)));return{x:o,z:t}}function j(e){var o;return p(e)?o=S:s(e)&&(o=Fe),o?o[e]:void 0}function L(e,o){e=e.split("");var t=E.indexOf(e[0])+1,n=parseInt(e[1],10);o=o.split("");var r=E.indexOf(o[0])+1,i=parseInt(o[1],10),a=Math.abs(t-r),s=Math.abs(n-i);return a>=s?a:s}function A(e){var o,t,n=[];for(o=0;8>o;o++)for(t=0;8>t;t++){var r=E[o]+(t+1);e!==r&&n.push({square:r,distance:L(e,r)})}n.sort(function(e,o){return e.distance-o.distance});var i=[];for(o=0;o<n.length;o++)i.push(n[o].square);return i}function V(e,o,t){for(var n=A(t),r=0;r<n.length;r++){var i=n[r];if(e.hasOwnProperty(i)===!0&&e[i]===o)return i}return!1}function G(e,o){var t,n=r(e),i=r(o),a=[];for(t in i)i.hasOwnProperty(t)===!0&&n.hasOwnProperty(t)===!0&&n[t]===i[t]&&(delete n[t],delete i[t]);for(t in i)if(i.hasOwnProperty(t)===!0){var s=V(n,i[t],t);s!==!1&&(a.push({type:"move",source:s,destination:t,piece:i[t]}),delete n[s],delete i[t])}for(t in i)i.hasOwnProperty(t)===!0&&(a.push({type:"add",square:t,piece:i[t]}),delete i[t]);for(t in n)n.hasOwnProperty(t)===!0&&(a.push({type:"clear",square:t,piece:n[t]}),delete n[t]);return a}function W(e,o){var t=new THREE.Vector3(e/ge.domElement.width*2-1,1-o/ge.domElement.height*2,-.5);return t.unproject(Se),new THREE.Raycaster(Se.position,t.sub(Se.position).normalize())}function U(e,o,t){var n=new THREE.Plane(new THREE.Vector3(0,1,0),-t),r=W(e,o),i=r.ray.intersectPlane(n);return i?new THREE.Vector3(i.x,t,i.z):null}function K(e,o){for(var t in Xe)if(Xe.hasOwnProperty(t)){var n=Pe.getObjectById(Xe[t]);if(e>=n.position.x-g/2&&e<n.position.x+g/2&&o>=n.position.z-g/2&&o<n.position.z+g/2)return t}if(c.sparePieces){var r;if(o>=4*g&&6*g>=o)r="w";else{if(!(-4*g>=o&&o>=-6*g))return"offboard";r="b"}var i=Math.round(1+(10-3*e/g)/4);if(i>=1&&6>=i)return t="s"+r+i}return"offboard"}function Q(e,o){var t,n,r,i,a=W(e,o),s={},p=[],c=0;for(n in Ye)if(Ye.hasOwnProperty(n)){var l=Pe.getObjectById(Ye[n]);r=j(n);var u=Ke[r.charAt(1)].boundingBox.clone();u.min.x+=l.position.x,u.max.x+=l.position.x,u.min.z+=l.position.z,u.max.z+=l.position.z,t=a.ray.intersectBox(u),t&&(s[n]=t,p.push(l),c++)}if(p.length>0){if(1===p.length)return n=Object.keys(s)[0],t=s[n],i=p[0],{source:n,location:n,piece:j(n),mesh:i,intersection_point:t,off_center_x:t.x-i.position.x,off_center_z:t.z-i.position.z};var f=a.intersectObjects(p);if(f.length>0)for(n in s)if(s.hasOwnProperty(n)&&(i=Pe.getObjectById(Ye[n]),i===f[0].object))return t=f[0].point,{source:n,location:n,piece:j(n),mesh:i,intersection_point:t,off_center_x:t.x-i.position.x,off_center_z:t.z-i.position.z}}var d=U(e,o,0);return d?(n=K(d.x,d.z),r=j(n),i=Pe.getObjectById(Ye[n]),{source:n,location:n,piece:r,mesh:i,intersection_point:new THREE.Vector3(d.x,0,d.z),off_center_x:i?d.x-i.position.x:void 0,off_center_z:i?d.z-i.position.z:void 0}):{source:"offboard",location:"offboard"}}function J(e,o,t){var n=U(o,t,e.intersection_point.y);n&&(n.x-=e.off_center_x,n.z-=e.off_center_z,e.location=K(n.x,n.z),e.mesh.position.x===n.x&&e.mesh.position.z===n.z||(e.mesh.position.x=n.x,e.mesh.position.z=n.z))}function $(){for(var e in S)if(S.hasOwnProperty(e)){var o=S[e],t=T(e,o);t.position.y=-.5,Ye[e]=t.id,Pe.add(t)}}function F(){if(ae(),p(Ze.source))Pe.remove(Ze.mesh),Ze=null;else{var e=Ze.mesh.position.x,t=Ze.mesh.position.z,n=Pe.getObjectById(Xe[Ze.source]),i=n.position.x,a=n.position.z,s=function(){Ze.mesh.position.x=i,Ze.mesh.position.z=a;var e=Ze.piece,o=Ze.source;Ze=null,c.hasOwnProperty("onSnapbackEnd")&&"function"==typeof c.onSnapbackEnd&&c.onSnapbackEnd(e,o,r(Fe),$e),Qe=!1,Je=!0};o(function(o){Ze.mesh.position.x=e+o*(i-e),Ze.mesh.position.z=t+o*(a-t)},s,100)}}function X(){if(ae(),Pe.remove(Ze.mesh),s(Ze.source)){var e=r(Fe);delete e[Ze.source],te(e),delete Ye[Ze.source]}Ze=null}function Y(){ae();var e=r(Fe),o=Pe.getObjectById(Xe[Ze.location]);Ze.mesh.position.x=o.position.x,Ze.mesh.position.z=o.position.z,s(Ze.source)&&(delete e[Ze.source],delete Ye[Ze.source]),e[Ze.location]&&Pe.remove(Pe.getObjectById(Ye[Ze.location])),e[Ze.location]=Ze.piece,Ye[Ze.location]=Ze.mesh.id;var t=Ze.source,n=Ze.location,i=Ze.piece;Ze=null,te(e),c.hasOwnProperty("onSnapEnd")&&"function"==typeof c.onSnapEnd&&c.onSnapEnd(t,n,i)}function Z(){for(var e in Ye)Ye.hasOwnProperty(e)===!0&&(p(e)||(Pe.remove(Pe.getObjectById(Ye[e])),delete Ye[e]));for(var o in Fe)if(Fe.hasOwnProperty(o)===!0){var t=T(o,Fe[o]);Ye[o]=t.id,Pe.add(t)}}function ee(){c.sparePieces&&$(),Z()}function oe(e,o){e=r(e);for(var t in o)if(o.hasOwnProperty(t)===!0&&e.hasOwnProperty(t)===!0){var n=e[t];delete e[t],e[o[t]]=n}return e}function te(e){var o=r(Fe),t=r(e),n=w(o),i=w(t);n!==i&&(c.hasOwnProperty("onChange")&&"function"==typeof c.onChange&&c.onChange(o,t),Fe=e)}function ne(e,o){o||(o=16776960);var t=Pe.getObjectById(Xe[e]),n=null;if(t){var r=new THREE.TorusGeometry(1.2*g/2,.1,4,4);n=new THREE.Mesh(r,new THREE.MeshBasicMaterial({color:new THREE.Color(o)})),n.position.x=t.position.x,n.position.y=0,n.position.z=t.position.z,n.rotation.z=Math.PI/4,n.rotation.x=Math.PI/2,Pe.add(n)}return n}function re(){eo&&(Pe.remove(eo),eo=null)}function ie(){oo&&(Pe.remove(oo),oo=null)}function ae(){re(),ie(),Re.removeGreySquares()}function se(e){re(),eo=ne(e)}function pe(e){ie(),oo=ne(e)}function ce(){Oe&&(Oe.enabled=!1),c.hasOwnProperty("onDragStart")&&"function"==typeof c.onDragStart&&c.onDragStart(Ze.source,Ze.piece,r(Fe),$e)===!1||(p(Ze.source)?(Ze.mesh=Ze.mesh.clone(),Ze.mesh.position.y=0,Pe.add(Ze.mesh),Je=!0):s(Ze.source)&&se(Ze.source))}function le(e,o){var t=Ze.location;J(Ze,e,o),t!==Ze.location&&(ie(),s(Ze.location)&&Ze.location!==Ze.source&&pe(Ze.location)),c.hasOwnProperty("onDragMove")&&"function"==typeof c.onDragMove&&c.onDragMove(Ze.location,t,Ze.source,Ze.piece,r(Fe),$e)}function ue(){var e="drop";if(("offboard"===Ze.location||p(Ze.location))&&("snapback"===c.dropOffBoard&&(e="snapback"),"trash"===c.dropOffBoard&&(e="trash")),c.hasOwnProperty("onDrop")&&"function"==typeof c.onDrop){var o=r(Fe);p(Ze.source)&&s(Ze.location)&&(o[Ze.location]=Ze.piece),s(Ze.source)&&!s(Ze.location)&&delete o[Ze.source],s(Ze.source)&&s(Ze.location)&&(delete o[Ze.source],o[Ze.location]=Ze.piece);var t=r(Fe),n=c.onDrop(Ze.source,Ze.location,Ze.piece,o,t,$e);"snapback"!==n&&"trash"!==n||(e=n)}"snapback"===e?F():"trash"===e?X():"drop"===e&&Y(),Oe&&(Oe.enabled=!0),Je=!0,ae()}function fe(e,o){var t,n,r=e.target||e.srcElement,i=r.getBoundingClientRect();return o&&e.touches.length>0?(t=e.touches[0].clientX-i.left,n=e.touches[0].clientY-i.top):(t=e.clientX-i.left,n=e.clientY-i.top),{x:t,y:n}}function de(e,o){if(e.preventDefault(),!Ze&&c.draggable){var t=fe(e,o),n=Q(t.x,t.y);n&&void 0!==n.piece?(Ze=n,no="offboard",ce()):Oe&&(Oe.enabled=!0)}}function he(e,o){e.preventDefault();var t=fe(e,o);if(Ze)le(t.x,t.y);else{var n,i;if(c.hasOwnProperty("onMouseoutSquare")&&"function"==typeof c.onMouseoutSquare&&(n=c.onMouseoutSquare),c.hasOwnProperty("onMouseoverSquare")&&"function"==typeof c.onMouseoverSquare&&(i=c.onMouseoverSquare),n||i){var a=Q(t.x,t.y).source,p=r(Fe);if(a!==no){var l;n&&s(no)&&(l=!1,p.hasOwnProperty(no)&&(l=p[no]),n(no,l,p,$e)),i&&s(a)&&(l=!1,p.hasOwnProperty(a)&&(l=p[a]),i(a,l,p,$e)),no=a}}}}function we(e){e.preventDefault(),Ze&&ue()}function ve(e){var o;if("function"==typeof c.pieceSet)o=c.pieceSet(e);else if("string"==typeof c.pieceSet){var t=c.pieceSet;o=t.replace("{piece}",e)}var n=new THREE.JSONLoader;c.hasOwnProperty("localStorage")&&c.localStorage===!1&&window.localStorage.removeItem(o);var r=window.localStorage.getItem(o);if(r){var i=JSON.parse(r),a=n.parse(i.data);Ke[e]=a.geometry,Ke[e].computeBoundingBox()}else n.load(o,function(t){Ke[e]=t,t.computeBoundingBox(),c.hasOwnProperty("localStorage")!==!1&&c.localStorage===!1||window.localStorage.setItem(o,JSON.stringify(t.toJSON()))})}function ye(){return void 0!==Ke.P&&void 0!==Ke.N&&void 0!==Ke.B&&void 0!==Ke.R&&void 0!==Ke.Q&&void 0!==Ke.K}function Ee(){function e(){ye()?(ee(),o()):setTimeout(e,20)}function o(){requestAnimationFrame(o),t();var e=Se.position.clone();Oe&&Oe.enabled&&Oe.update();var n=Se.position.x!==e.x||Se.position.y!==e.y||Se.position.z!==e.z;if(Je||n){var i=Se.position.x,a=Se.position.y,s=Se.position.z;for(var p in be)be.hasOwnProperty(p)&&be[p].lookAt(new THREE.Vector3(100*i,100*a,100*s));-8>=i?(Le.opacity=1,Ae.opacity=0):i>=8?(Le.opacity=0,Ae.opacity=1):Le.opacity=Ae.opacity=1,-8>=s?(_e.opacity=1,je.opacity=0):s>=8?(_e.opacity=0,je.opacity=1):_e.opacity=je.opacity=1}if(Je||null!==Ze||Qe||n){var l=!0;if(c.hasOwnProperty("onRender")&&"function"==typeof c.onRender&&c.onRender(Pe,r(Xe),r(Ye),r(Fe))===!1&&(l=!1),l){if(!Ce){for(;me.firstChild;)me.removeChild(me.firstChild);me.appendChild(ge.domElement),Ce=!0}ge.render(Pe,Se),Je=!1}else Je=!0}}if(d()===!0&&R()===!0){var n=O;me.style.width&&me.style.width.match(/px/)&&(n=parseInt(me.style.width.replace(/px/,"")));var i=3*n/4;!me.style.height&&me.style.height.match(/px/)&&(i=Math.max(i,parseInt(me.style.height.replace(/px/,"")))),me.style.width=n.toString()+"px",me.style.height=i.toString()+"px",Re.resize(),z(),B(),ve("K"),ve("Q"),ve("R"),ve("B"),ve("N"),ve("P"),e()}}c=c||{};var me,ge,Pe,be,Se,Oe,xe=h(y),Ce=!1,Re={},ze=new THREE.Vector3(0,b*Math.cos(P),b*Math.sin(P)),Me=new THREE.Vector3(0,b*Math.cos(P),-b*Math.sin(P)),Te=11184810;c.hasOwnProperty("whitePieceColor")&&"number"==typeof c.whitePieceColor&&(Te=c.whitePieceColor);var He=new THREE.MeshPhongMaterial({color:new THREE.Color(Te)}),Be=13434879;c.hasOwnProperty("whitePieceSpecular")&&"number"==typeof c.whitePieceSpecular&&(Be=c.whitePieceSpecular),He.specular=new THREE.Color(Be),He.transparent=!0;var Ie=3355443;c.hasOwnProperty("blackPieceColor")&&"number"==typeof c.blackPieceColor&&(Ie=c.blackPieceColor);var ke=new THREE.MeshPhongMaterial({color:new THREE.Color(Ie)}),qe=5583667;c.hasOwnProperty("blackPieceSpecular")&&"number"==typeof c.blackPieceSpecular&&(qe=c.blackPieceSpecular),ke.specular=new THREE.Color(qe),ke.transparent=!0;var Ne=0;c.hasOwnProperty("notationColor")&&"number"==typeof c.notationColor&&(Ne=c.notationColor);var De=new THREE.MeshBasicMaterial({color:new THREE.Color(Ne)});De.transparent=!0;var _e=De.clone(),je=De.clone(),Le=De.clone(),Ae=De.clone(),Ve=11962467;c.hasOwnProperty("darkSquareColor")&&"number"==typeof c.darkSquareColor&&(Ve=c.darkSquareColor);var Ge=new THREE.MeshPhongMaterial({color:new THREE.Color(Ve)}),We=15784373;c.hasOwnProperty("lightSquareColor")&&"number"==typeof c.lightSquareColor&&(We=c.lightSquareColor);var Ue=new THREE.MeshPhongMaterial({color:new THREE.Color(We)}),Ke={K:void 0,Q:void 0,R:void 0,B:void 0,N:void 0,P:void 0},Qe=!1,Je=!0,$e="white",Fe={},Xe={},Ye={},Ze=null,eo=null,oo=null,to=[],no="offboard";return Re.clear=function(e){Re.position({},e)},Re.destroy=function(){ge.domElement.removeEventListener("mousedown",de),ge.domElement.removeEventListener("mousemove",he),ge.domElement.removeEventListener("mouseup",we),me.removeChild(ge.domElement)},Re.fen=function(){return Re.position("fen")},Re.flip=function(){return Re.orientation("flip")},Re.greySquare=function(e){to.push(ne(e,4210752)),Je=!0},Re.removeGreySquares=function(){for(;to.length>0;)Pe.remove(to.pop());to=[],Je=!0},Re.move=function(){if(0!==arguments.length){for(var e=!0,o={},t=0;t<arguments.length;t++)if(arguments[t]!==!1)if(i(arguments[t])===!0){var n=arguments[t].split("-");o[n[0]]=n[1]}else f(2826,"Invalid move passed to the move method.",arguments[t]);else e=!1;var r=oe(Fe,o);return Re.position(r,e),r}},Re.orientation=function(e){return 0===arguments.length?$e:"white"===e||"black"===e?($e=e,M("white"===e?ze:Me),$e):"flip"===e?($e="white"===$e?"black":"white",M("white"===$e?ze:Me),$e):void f(5482,"Invalid value passed to the orientation method.",e)},Re.flip=function(){Re.orientation("flip")},Re.position=function(e,o){if(0===arguments.length)return r(Fe);if("string"==typeof e&&"fen"===e.toLowerCase())return w(Fe);if(o!==!1&&(o=!0),"string"==typeof e&&"start"===e.toLowerCase()&&(e=r(xe)),l(e)===!0&&(e=h(e)),u(e)!==!0)return void f(6482,"Invalid value passed to the position method.",e);var t=function(){if(o){var t=G(Fe,e);D(t,Fe,e)}else te(e),Z(),Je=!0};if(ye()&&Qe===!1)t();else{var n=function(){ye()===!1||Qe?setTimeout(n,100):t()};n()}},Re.resize=function(){var e=me.clientWidth;e&=65532;var o=e*x;me.style.width=e,me.style.height=o,Se&&Se.updateProjectionMatrix(),ge&&ge.setSize(me.clientWidth,me.clientHeight),Je=!0},Re.rerender=function(){Je=!0},Re.start=function(e){Re.position("start",e)},Ee(),Re},window.ChessBoard3.webGLEnabled=n,window.ChessBoard3.fenToObj=h,window.ChessBoard3.objToFen=w}();