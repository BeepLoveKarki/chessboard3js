!function(){"use strict";function e(){return window.hasOwnProperty("WebGLRenderingContext")}function o(e){return JSON.parse(JSON.stringify(e))}function t(e){if("string"!=typeof e)return!1;var o=e.split("-");return 2!==o.length?!1:n(o[0])&&n(o[1])}function n(e){return r(e)||i(e)}function r(e){return"string"!=typeof e?!1:-1!==e.search(/^[a-h][1-8]$/)}function i(e){return"string"!=typeof e?!1:-1!==e.search(/^s[bw][1-6]$/)}function a(e){return"string"!=typeof e?!1:-1!==e.search(/^[bw][KQRNBP]$/)}function s(e){if("string"!=typeof e)return!1;e=e.replace(/ .+$/,"");var o=e.split("/");if(8!==o.length)return!1;for(var t=0;8>t;t++)if(""===o[t]||o[t].length>8||-1!==o[t].search(/[^kqrbnpKQRNBP1-8]/))return!1;return!0}function p(e){if("object"!=typeof e)return!1;for(var o in e)if(e.hasOwnProperty(o)===!0&&(n(o)!==!0||a(e[o])!==!0))return!1;return!0}function c(e){return e.toLowerCase()===e?"b"+e.toUpperCase():"w"+e.toUpperCase()}function l(e){var o=e.split("");return"w"===o[0]?o[1].toUpperCase():o[1].toLowerCase()}function u(e){if(s(e)!==!0)return!1;e=e.replace(/ .+$/,"");for(var o=e.split("/"),t={},n=8,r=0;8>r;r++){for(var i=o[r].split(""),a=0,p=0;p<i.length;p++)if(-1!==i[p].search(/[1-8]/))a+=parseInt(i[p],10);else{var l=w[a]+n;t[l]=c(i[p]),a++}n--}return t}function f(e){if(p(e)!==!0)return!1;for(var o="",t=8,n=0;8>n;n++){for(var r=0;8>r;r++){var i=w[r]+t;o+=e.hasOwnProperty(i)===!0?l(e[i]):"1"}7!==n&&(o+="/"),t--}return o=o.replace(/11111111/g,"8"),o=o.replace(/1111111/g,"7"),o=o.replace(/111111/g,"6"),o=o.replace(/11111/g,"5"),o=o.replace(/1111/g,"4"),o=o.replace(/111/g,"3"),o=o.replace(/11/g,"2")}var d=71,h="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR",w="abcdefgh".split(""),v=[[50,40,30],[-50,0,-30]],E=2,y=Math.PI/4,m=18.25,g={sw1:"wK",sw2:"wQ",sw3:"wR",sw4:"wB",sw5:"wN",sw6:"wP",sb1:"bK",sb2:"bQ",sb3:"bR",sb4:"bB",sb5:"bN",sb6:"bP"},P=.75;window.ChessBoard3=window.ChessBoard3||function(n,a){function c(e,o,t){a.showErrors;if(a.hasOwnProperty("showErrors")===!0&&a.showErrors!==!1){var n="ChessBoard3 Error "+e+": "+o;return a.hasOwnProperty("showErrors")&&"console"===a.showErrors&&"object"==typeof console&&"function"==typeof console.log?(console.log(n),void(arguments.length>=2&&console.log(t))):"alert"===a.showErrors?(t&&(n+="\n\n"+JSON.stringify(t)),void window.alert(n)):void("function"==typeof a.showErrors&&a.showErrors.call(e,o,t))}}function l(){if(void 0===THREE||void 0===THREE.REVISION||isNaN(parseInt(THREE.REVISION))||parseInt(THREE.REVISION)<d)return console.log("ChessBoard3 Error 3006: Unable to find three.js revision 71 or greater. \n\nExiting..."),!1;if(!window.JSON||"function"!=typeof JSON.stringify||"function"!=typeof JSON.parse)return window.alert("ChessBoard3 Error 1004: JSON does not exist in this browser. Please include a JSON polyfill.\n\nExiting..."),!1;if(!e())return window.alert("ChessBoard3 Error 3001: WebGL is not enabled.\n\nExiting..."),!1;if("string"==typeof n){if(""===n)return window.alert("ChessBoard3 Error 1001: The first argument to ChessBoard3() cannot be an empty string.\n\nExiting..."),!1;var o=document.getElementById(n);if(!o)return window.alert('ChessBoard Error 1002: Element with id "'+n+'"does not exist in the DOM.\n\nExiting...'),!1;he=o}else if(he=n,-1!==he.length)return window.alert("ChessBoard3 Error 1003: The first argument to ChessBoard3() must be an ID or a single DOM node.\n\nExiting..."),!1;return!0}function S(e){return"fast"===e||"slow"===e?!0:parseInt(e,10)+""!=e+""?!1:e>=0}function b(){return("string"==typeof a||p(a))&&(a={position:a}),"black"!==a.orientation&&(a.orientation="white"),Ve=a.orientation,a.showNotation!==!1&&(a.showNotation=!0),a.draggable!==!0&&(a.draggable=!1),"trash"!==a.dropOffBoard&&(a.dropOffBoard="snapback"),a.sparePieces!==!0&&(a.sparePieces=!1),a.sparePieces===!0&&(a.draggable=!0),(a.hasOwnProperty("pieceSet")!==!0||"string"!=typeof a.pieceSet&&"function"!=typeof a.pieceSet)&&(a.pieceSet="assets/chesspieces/wikipedia/{piece}.json"),a.rotateControls!==!1&&(a.rotateControls=!0),a.zoomControls!==!0&&(a.zoomControls=!1),a.hasOwnProperty("appearSpeed")!==!0||S(a.appearSpeed)!==!0?a.appearSpeed=200:a.hasOwnProperty("appearSpeed")&&("slow"===a.appearSpeed?a.appearSpeed=400:"fast"===a.appearSpeed&&(a.appearSpeed=100)),a.hasOwnProperty("moveSpeed")!==!0||S(a.moveSpeed)!==!0?a.moveSpeed=200:a.hasOwnProperty("moveSpeed")&&("slow"===a.moveSpeed?a.moveSpeed=400:"fast"===a.moveSpeed&&(a.moveSpeed=100)),a.hasOwnProperty("snapbackSpeed")!==!0||S(a.snapbackSpeed)!==!0?a.snapbackSpeed=50:a.hasOwnProperty("snapbackSpeed")&&("slow"===a.snapbackSpeed?a.snapbackSpeed=100:"fast"===a.snapbackSpeed&&(a.snapbackSpeed=25)),a.hasOwnProperty("snapSpeed")!==!0||S(a.snapSpeed)!==!0?a.snapSpeed=25:a.hasOwnProperty("snapSpeed")&&("slow"===a.snapSpeed?a.snapSpeed=50:"fast"===a.snapSpeed&&(a.snapSpeed=10)),a.hasOwnProperty("trashSpeed")!==!0||S(a.trashSpeed)!==!0?a.trashSpeed=100:a.hasOwnProperty("trashSpeed")&&("slow"===a.trashSpeed?a.trashSpeed=200:"fast"===a.trashSpeed&&(a.trashSpeed=50)),a.hasOwnProperty("position")===!0&&("start"===a.position?Je=o(ge):s(a.position)===!0?Je=u(a.position):p(a.position)===!0?Je=o(a.position):c(7263,"Invalid value passed to config.position.",a.position)),!0}function O(){"black"!==a.orientation&&(a.orientation="white"),we=new THREE.WebGLRenderer({alpha:!0,preserveDrawingBuffer:!0,antialias:!0,transparent:!0}),we.shadowMapEnabled=!0,we.shadowMapType=THREE.PCFSoftShadowMap;var e;e=a.hasOwnProperty("backgroundColor")&&"number"==typeof a.backgroundColor?a.backgroundColor:12303291,we.setClearColor(e,1),we.setSize(he.clientWidth,Math.round(he.clientWidth*P)),he.appendChild(we.domElement),ve=new THREE.Scene,ye=new THREE.PerspectiveCamera(60,he.clientWidth/he.clientHeight,.1,1e3),ye.aspectRatio=P,a.sparePieces===!1&&(Se.multiplyScalar(.9),be.multiplyScalar(.9)),"white"===a.orientation?ye.position.set(Se.x,Se.y,Se.z):"black"===a.orientation&&ye.position.set(be.x,be.y,be.z),ye.lookAt(new THREE.Vector3(0,-3,0)),ve.add(ye),we.domElement.addEventListener("mousedown",pe,!0),we.domElement.addEventListener("mousemove",ce,!0),we.domElement.addEventListener("mouseup",le,!0),"ontouchstart"in document.documentElement&&(we.domElement.addEventListener(!0),we.domElement.addEventListener("touchmove",ce,!0),we.domElement.addEventListener("touchend",le,!0)),(a.rotateControls||a.zoomControls)&&void 0!==THREE.OrbitControls&&(me=new THREE.OrbitControls(ye,we.domElement,we.domElement),me.noPan=!0,a.rotateControls?(me.minPolarAngle=Math.PI/2*.1,me.maxPolarAngle=Math.PI/2*.8):me.noRotate=!0,a.zoomControls?(me.minDistance=12,me.maxDistance=22):me.noZoom=!0,me.target.y=-3,me.enabled=!0)}function x(e){Le=!0;var o=ye.position,t=o.y,n=e.y,r=Math.sqrt(Math.pow(o.x,2)+Math.pow(o.z,2)),i=Math.sqrt(Math.pow(e.x,2)+Math.pow(e.z,2)),a=Math.acos(o.x/r),s=Math.acos(e.x/i);o.z<0&&(a=-a),e.z<0&&(s=-s),(s-a>=Math.PI||a-s>Math.PI)&&(s>a?s-=2*Math.PI:s+=2*Math.PI);var p=function(){ye.position.set(e.x,e.y,e.z),ye.lookAt(new THREE.Vector3(0,-3,0)),Le=!1,je=!0};if(void 0!==window.TWEEN&&"object"==typeof TWEEN){var c=new TWEEN.Tween({t:0}).to({t:1},1e3).onUpdate(function(){var e=this.t,o=a+e*(s-a),p=r+e*(i-r);ye.position.set(p*Math.cos(o),t+e*(n-t),p*Math.sin(o)),ye.lookAt(new THREE.Vector3(0,-3,0))}).onComplete(p);c.start()}else p()}function T(e,o){var t,n=k(e),r=o.charAt(0),i=o.charAt(1);"w"===r?t=xe.clone():"b"===r&&(t=Re.clone());var a,s;return a=De[i],s=new THREE.Mesh(a,t),s.position.x=n.x,s.position.z=n.z,s.castShadow=!0,s}function C(){var e;for(e=0;8>e;e++)for(var o=3.5*E-E*e,t=0;8>t;t++){var n=E*t-3.5*E,r="abcdefgh".charAt(t)+(e+1),i=e%2===0^t%2===0?Ae:_e,s=new THREE.BoxGeometry(2,.5,2),p=new THREE.Mesh(s,i);p.position.set(n,-.25,o),s.computeVertexNormals(),s.computeFaceNormals(),s.computeTangents(),p.receiveShadow=!0,Ue[r]=p,p.tag=r,ve.add(p)}var l={size:.5,height:0,weight:"normal",font:"helvetiker",style:"normal",curveSegments:12,steps:1};if(Ee=[],a.showNotation){var u,f,d="abcdefgh".split("");for(e=0;8>e;e++){try{u=new THREE.TextGeometry(d[e],l)}catch(h){a.showNotation=!1,c(2354,h);break}f=new THREE.Mesh(u,Ne),f.position.x=2*e-7-l.size/2,f.position.y=-.5,f.position.z=-9,Ee.push(f),ve.add(f),f=new THREE.Mesh(u,ke),f.position.x=2*e-7-l.size/2,f.position.y=-.5,f.position.z=9,Ee.push(f),ve.add(f)}if(Ee.length>0){var w="12345678".split("");for(e=0;8>e;e++)u=new THREE.TextGeometry(w[e],l),f=new THREE.Mesh(u,Be),f.position.x=-9,f.position.y=-.5,f.position.z=-7-l.size/2+2*(7-e),Ee.push(f),ve.add(f),f=new THREE.Mesh(u,Ie),f.position.x=9,f.position.y=-.5,f.position.z=-7-l.size/2+2*(7-e),Ee.push(f),ve.add(f)}}for(var y=0;y<v.length;y++){var m=new THREE.SpotLight(11184810),g=v[y];m.position.set(g[0],g[1],g[2]),m.target=new THREE.Object3D,0===y&&(m.castShadow=!0,m.shadowBias=1e-4,m.shadowDarkness=.2,m.shadowMapWidth=2048,m.shadowMapHeight=2048),ve.add(m)}var P=new THREE.AmbientLight(5592405);ve.add(P)}function R(){for(var e in Ge)Ge.hasOwnProperty(e)&&!i(e)&&Je.hasOwnProperty(e)===!1&&c(3701,"Square "+e+" in PIECE_MESHES but not in CURRENT_POSITION");for(e in Je)Je.hasOwnProperty(e)&&Ge.hasOwnProperty(e)===!1&&c(3702,"Square "+e+" in CURRENT_POSITION but not in PIECE_MESHES")}function z(e,o,t){var n,s;if(Ge.hasOwnProperty(e)&&(s=Ge[e]),Ue.hasOwnProperty(o)&&(n=Ue[o]),i(e)&&(s=s.clone(),ve.add(s)),n&&s){var p=s.position.x,c=s.position.z,l=n.position.x,u=n.position.z,f=new TWEEN.Tween({t:0}).to({t:1},a.moveSpeed).onUpdate(function(){var e=this.t;s.position.x=p+e*(l-p),s.position.z=c+e*(u-c)}).onComplete(function(){Ge[o]=s,r(e)&&s===Ge[e]&&delete Ge[e],t()});f.start()}}function M(e,o){if(Ge.hasOwnProperty(e)&&r(e)&&Ge.hasOwnProperty(e)){var t=Ge[e],n=new TWEEN.Tween({t:1}).to({t:0},a.trashSpeed).onUpdate(function(){t.opacity=this.t}).onComplete(function(){ve.remove(Ge[e]),delete Ge[e],o()});n.start()}}function H(e,o,t){var n=T(e,o);n.opacity=0,ve.add(n);var r=new TWEEN.Tween({t:0}).to({t:1},a.appearSpeed).onUpdate(function(){n.opacity=this.t}).onComplete(function(){Ge[e]=n,t()});r.start()}function N(e,t,n){function i(){p--,0===p&&(X(n),a.hasOwnProperty("moveEnd")&&"function"==typeof a.onMoveEnd&&a.onMoveEnd(o(t,o(n))),je=!0,R(),Le=!1)}if(0!==e.length){Le=!0;var s,p=e.length;for(s=0;s<e.length;s++)"clear"===e[s].type&&r(e[s].square)&&Ge.hasOwnProperty(e[s].square)&&M(e[s].square,i);for(s=0;s<e.length;s++)"move"===e[s].type&&z(e[s].source,e[s].destination,i);for(s=0;s<e.length;s++)if("add"===e[s].type)if(a.sparePieces===!0)for(var c in g)g.hasOwnProperty(c)&&g[c]===e[s].piece&&z(c,e[s].square,i);else H(e[s].square,e[s].piece,i)}}function k(e){var o,t;if(i(e)){var n=e.charCodeAt(2)-"1".charCodeAt(0);o=E*(4*n-10)/3,"w"==e.charAt(1)?t=5*E:"b"==e.charAt(1)&&(t=-5*E)}else r(e)&&(o=E*(e.charCodeAt(0)-"a".charCodeAt(0))-3.5*E,t=3.5*E-E*(e.charCodeAt(1)-"1".charCodeAt(0)));return{x:o,z:t}}function B(e){var o;return i(e)?o=g:r(e)&&(o=Je),o?o[e]:void 0}function I(e,o){e=e.split("");var t=w.indexOf(e[0])+1,n=parseInt(e[1],10);o=o.split("");var r=w.indexOf(o[0])+1,i=parseInt(o[1],10),a=Math.abs(t-r),s=Math.abs(n-i);return a>=s?a:s}function q(e){var o,t,n=[];for(o=0;8>o;o++)for(t=0;8>t;t++){var r=w[o]+(t+1);e!==r&&n.push({square:r,distance:I(e,r)})}n.sort(function(e,o){return e.distance-o.distance});var i=[];for(o=0;o<n.length;o++)i.push(n[o].square);return i}function _(e,o,t){for(var n=q(t),r=0;r<n.length;r++){var i=n[r];if(e.hasOwnProperty(i)===!0&&e[i]===o)return i}return!1}function W(e,t){var n,r=o(e),i=o(t),a=[];for(n in i)i.hasOwnProperty(n)===!0&&r.hasOwnProperty(n)===!0&&r[n]===i[n]&&(delete r[n],delete i[n]);for(n in i)if(i.hasOwnProperty(n)===!0){var s=_(r,i[n],n);s!==!1&&(a.push({type:"move",source:s,destination:n,piece:i[n]}),delete r[s],delete i[n])}for(n in i)i.hasOwnProperty(n)===!0&&(a.push({type:"add",square:n,piece:i[n]}),delete i[n]);for(n in r)r.hasOwnProperty(n)===!0&&(a.push({type:"clear",square:n,piece:r[n]}),delete r[n]);return a}function A(e,o){var t=new THREE.Vector3(e/we.domElement.width*2-1,1-o/we.domElement.height*2,-.5);return t.unproject(ye),new THREE.Raycaster(ye.position,t.sub(ye.position).normalize())}function D(e,o,t){var n=new THREE.Plane(new THREE.Vector3(0,1,0),-t),r=A(e,o),i=r.ray.intersectPlane(n);return i?new THREE.Vector3(i.x,t,i.z):null}function L(e,o){for(var t in Ue)if(Ue.hasOwnProperty(t)){var n=Ue[t];if(e>=n.position.x-E/2&&e<n.position.x+E/2&&o>=n.position.z-E/2&&o<n.position.z+E/2)return t}if(a.sparePieces){var r;if(o>=4*E&&6*E>=o)r="w";else{if(!(-4*E>=o&&o>=-6*E))return"offboard";r="b"}var i=Math.round(1+(10-3*e/E)/4);if(i>=1&&6>=i)return t="s"+r+i}return"offboard"}function j(e,o){var t,n,r,i=A(e,o),a={},s=[],p=0;for(n in Ge)if(Ge.hasOwnProperty(n)){var c=Ge[n];r=B(n);var l=De[r.charAt(1)].boundingBox.clone();l.min.x+=c.position.x,l.max.x+=c.position.x,l.min.z+=c.position.z,l.max.z+=c.position.z,t=i.ray.intersectBox(l),t&&(a[n]=t,s.push(c),p++)}if(s.length>0){if(1===s.length)return n=Object.keys(a)[0],t=a[n],{source:n,location:n,piece:B(n),mesh:Ge[n],intersection_point:t,off_center_x:t.x-Ge[n].position.x,off_center_z:t.z-Ge[n].position.z};var u=i.intersectObjects(s);if(u.length>0)for(n in a)if(a.hasOwnProperty(n)&&Ge[n]===u[0].object)return t=u[0].point,{source:n,location:n,piece:B(n),mesh:Ge[n],intersection_point:t,off_center_x:t.x-Ge[n].position.x,off_center_z:t.z-Ge[n].position.z}}var f=D(e,o,0);if(!f)return{source:"offboard",location:"offboard"};n=L(f.x,f.z),r=B(n);var d=Ge[n];return{source:n,location:n,piece:r,mesh:d,intersection_point:new THREE.Vector3(f.x,0,f.z),off_center_x:d?f.x-d.position.x:void 0,off_center_z:d?f.z-d.position.z:void 0}}function V(e,o,t){var n=D(o,t,e.intersection_point.y);n&&(n.x-=e.off_center_x,n.z-=e.off_center_z,e.location=L(n.x,n.z),(e.mesh.position.x!==n.x||e.mesh.position.z!==n.z)&&(e.mesh.position.x=n.x,e.mesh.position.z=n.z))}function J(){for(var e in g)if(g.hasOwnProperty(e)){var o=g[e],t=T(e,o);t.position.y=-.5,Ge[e]=t,ve.add(t)}}function U(){if(oe(),i(Ke.source))ve.remove(Ke.mesh),Ke=null;else{var e=Ke.mesh.position.x,t=Ke.mesh.position.z,n=Ue[Ke.source].position.x,r=Ue[Ke.source].position.z,s=function(){Ke.mesh.position.x=n,Ke.mesh.position.z=r;var e=Ke.piece,t=Ke.source;Ke=null,a.hasOwnProperty("onSnapbackEnd")&&"function"==typeof a.onSnapbackEnd&&a.onSnapbackEnd(e,t,o(Je),Ve),Le=!1,je=!0};if(void 0!==window.TWEEN&&"object"==typeof TWEEN){var p=new TWEEN.Tween({t:0}).to({t:1},100).onUpdate(function(){var o=this.t;Ke.mesh.position.x=e+o*(n-e),Ke.mesh.position.z=t+o*(r-t)}).onComplete(s);p.start()}else s()}}function G(){if(oe(),ve.remove(Ke.mesh),r(Ke.source)){var e=o(Je);delete e[Ke.source],X(e),delete Ge[Ke.source]}Ke=null}function K(){oe();var e=o(Je);Ke.mesh.position.x=Ue[Ke.location].position.x,Ke.mesh.position.z=Ue[Ke.location].position.z,r(Ke.source)&&(delete e[Ke.source],delete Ge[Ke.source]),e[Ke.location]&&ve.remove(Ge[Ke.location]),e[Ke.location]=Ke.piece,Ge[Ke.location]=Ke.mesh;var t=Ke.source,n=Ke.location,i=Ke.piece;Ke=null,X(e),a.hasOwnProperty("onSnapEnd")&&"function"==typeof a.onSnapEnd&&a.onSnapEnd(t,n,i)}function Q(){for(var e in Ge)Ge.hasOwnProperty(e)===!0&&(i(e)||(ve.remove(Ge[e]),delete Ge[e]));for(var o in Je)if(Je.hasOwnProperty(o)===!0){var t=T(o,Je[o]);Ge[o]=t,ve.add(t)}}function $(){a.sparePieces&&J(),Q()}function F(e,t){e=o(e);for(var n in t)if(t.hasOwnProperty(n)===!0&&e.hasOwnProperty(n)===!0){var r=e[n];delete e[n],e[t[n]]=r}return e}function X(e){var t=o(Je),n=o(e),r=f(t),i=f(n);r!==i&&(a.hasOwnProperty("onChange")&&"function"==typeof a.onChange&&a.onChange(t,n),Je=e)}function Y(e,o){o||(o=16776960);var t=Ue[e],n=null;if(t){var r=new THREE.TorusGeometry(1.2*E/2,.1,4,4);n=new THREE.Mesh(r,new THREE.MeshBasicMaterial({color:new THREE.Color(o)})),n.position.x=t.position.x,n.position.y=0,n.position.z=t.position.z,n.rotation.z=Math.PI/4,n.rotation.x=Math.PI/2,ve.add(n)}return n}function Z(){Qe&&(ve.remove(Qe),Qe=null)}function ee(){$e&&(ve.remove($e),$e=null)}function oe(){Z(),ee(),Pe.removeGreySquares()}function te(e){Z(),Qe=Y(e)}function ne(e){ee(),$e=Y(e)}function re(){me&&(me.enabled=!1),a.hasOwnProperty("onDragStart")&&"function"==typeof a.onDragStart&&a.onDragStart(Ke.source,Ke.piece,o(Je),Ve)===!1||(i(Ke.source)?(Ke.mesh=Ke.mesh.clone(),Ke.mesh.position.y=0,ve.add(Ke.mesh),je=!0):r(Ke.source)&&te(Ke.source))}function ie(e,t){var n=Ke.location;V(Ke,e,t),n!==Ke.location&&(ee(),r(Ke.location)&&Ke.location!==Ke.source&&ne(Ke.location)),a.hasOwnProperty("onDragMove")&&"function"==typeof a.onDragMove&&a.onDragMove(Ke.location,n,Ke.source,Ke.piece,o(Je),Ve)}function ae(){var e="drop";if(("offboard"===Ke.location||i(Ke.location))&&("snapback"===a.dropOffBoard&&(e="snapback"),"trash"===a.dropOffBoard&&(e="trash")),a.hasOwnProperty("onDrop")&&"function"==typeof a.onDrop){var t=o(Je);i(Ke.source)&&r(Ke.location)&&(t[Ke.location]=Ke.piece),r(Ke.source)&&!r(Ke.location)&&delete t[Ke.source],r(Ke.source)&&r(Ke.location)&&(delete t[Ke.source],t[Ke.location]=Ke.piece);var n=o(Je),s=a.onDrop(Ke.source,Ke.location,Ke.piece,t,n,Ve);("snapback"===s||"trash"===s)&&(e=s)}"snapback"===e?U():"trash"===e?G():"drop"===e&&K(),me&&(me.enabled=!0),je=!0,oe()}function se(e){var o=e.target||e.srcElement,t=o.getBoundingClientRect(),n=e.clientX-t.left,r=e.clientY-t.top;return{x:n,y:r}}function pe(e){if(e.preventDefault(),!Ke&&a.draggable){var o=se(e),t=j(o.x,o.y);t&&void 0!==t.piece?(Ke=t,Xe="offboard",re()):me&&(me.enabled=!0)}}function ce(e){e.preventDefault();var t=se(e);if(Ke)ie(t.x,t.y);else{var n,i;if(a.hasOwnProperty("onMouseoutSquare")&&"function"==typeof a.onMouseoutSquare&&(n=a.onMouseoutSquare),a.hasOwnProperty("onMouseoverSquare")&&"function"==typeof a.onMouseoverSquare&&(i=a.onMouseoverSquare),n||i){var s=j(t.x,t.y).source,p=o(Je);if(s!==Xe){var c;n&&r(Xe)&&(c=!1,p.hasOwnProperty(Xe)&&(c=p[Xe]),n(Xe,c,p,Ve)),i&&r(s)&&(c=!1,p.hasOwnProperty(s)&&(c=p[s]),i(s,c,p,Ve)),Xe=s}}}}function le(e){e.preventDefault(),Ke&&ae()}function ue(e){var o;if("function"==typeof a.pieceSet)o=a.pieceSet(e);else if("string"==typeof a.pieceSet){var t=a.pieceSet;o=t.replace("{piece}",e)}var n=new THREE.JSONLoader,r=window.localStorage.getItem(o);if(r){var i=JSON.parse(r),s=n.parse(i.data);De[e]=s.geometry,De[e].computeBoundingBox()}else n.load(o,function(t){De[e]=t,t.computeBoundingBox(),window.localStorage.setItem(o,JSON.stringify(t.toJSON()))})}function fe(){return void 0!==De.P&&void 0!==De.N&&void 0!==De.B&&void 0!==De.R&&void 0!==De.Q&&void 0!==De.K}function de(){function e(){fe()?($(),o()):setTimeout(e,20)}function o(){requestAnimationFrame(o),void 0!==window.TWEEN&&"object"==typeof window.TWEEN&&TWEEN.update();var e=ye.position.clone();me&&me.enabled&&me.update();var t=ye.position.x!==e.x||ye.position.y!==e.y||ye.position.z!==e.z;if(je||t){var n=ye.position.x,r=ye.position.y,i=ye.position.z;for(var s in Ee)Ee.hasOwnProperty(s)&&Ee[s].lookAt(new THREE.Vector3(100*n,100*r,100*i));-8>=n?(Be.opacity=1,Ie.opacity=0):n>=8?(Be.opacity=0,Ie.opacity=1):Be.opacity=Ie.opacity=1,-8>=i?(Ne.opacity=1,ke.opacity=0):i>=8?(Ne.opacity=0,ke.opacity=1):Ne.opacity=ke.opacity=1}(je||null!==Ke||Le||t)&&(we.render(ve,ye),a.hasOwnProperty("onRender")&&"function"==typeof a.onReady&&a.onRender(),je=!1)}if(l()===!0&&b()===!0){var t=parseInt(he.style.width.replace(/px/,"")),n=parseInt(he.style.height.replace(/px/,""));he.style.height=Math.max(n,3*t/4).toString()+"px",Pe.resize(),O(),C(),ue("K"),ue("Q"),ue("R"),ue("B"),ue("N"),ue("P"),e()}}a=a||{};var he,we,ve,Ee,ye,me,ge=u(h),Pe={},Se=new THREE.Vector3(0,m*Math.cos(y),m*Math.sin(y)),be=new THREE.Vector3(0,m*Math.cos(y),-m*Math.sin(y)),Oe=11184810;a.hasOwnProperty("whitePieceColor")&&"number"==typeof a.whitePieceColor&&(Oe=a.whitePieceColor);var xe=new THREE.MeshPhongMaterial({color:new THREE.Color(Oe)}),Te=13434879;a.hasOwnProperty("whitePieceSpecular")&&"number"==typeof a.whitePieceSpecular&&(Te=a.whitePieceSpecular),xe.specular=new THREE.Color(Te),xe.transparent=!0;var Ce=3355443;a.hasOwnProperty("blackPieceColor")&&"number"==typeof a.blackPieceColor&&(Ce=a.blackPieceColor);var Re=new THREE.MeshPhongMaterial({color:new THREE.Color(Ce)}),ze=5583667;a.hasOwnProperty("blackPieceSpecular")&&"number"==typeof a.blackPieceSpecular&&(ze=a.blackPieceSpecular),Re.specular=new THREE.Color(ze),Re.transparent=!0;var Me=0;a.hasOwnProperty("notationColor")&&"number"==typeof a.notationColor&&(Me=a.notationColor);var He=new THREE.MeshBasicMaterial({color:new THREE.Color(Me)});He.transparent=!0;var Ne=He.clone(),ke=He.clone(),Be=He.clone(),Ie=He.clone(),qe=11962467;a.hasOwnProperty("darkSquareColor")&&"number"==typeof a.darkSquareColor&&(qe=a.darkSquareColor);var _e=new THREE.MeshPhongMaterial({color:new THREE.Color(qe)}),We=15784373;a.hasOwnProperty("lightSquareColor")&&"number"==typeof a.lightSquareColor&&(We=a.lightSquareColor);var Ae=new THREE.MeshPhongMaterial({color:new THREE.Color(We)}),De={K:void 0,Q:void 0,R:void 0,B:void 0,N:void 0,P:void 0},Le=!1,je=!0,Ve="white",Je={},Ue={},Ge={},Ke=null,Qe=null,$e=null,Fe=[],Xe="offboard";return Pe.clear=function(e){Pe.position({},e)},Pe.destroy=function(){we.domElement.removeEventListener("mousedown",pe),we.domElement.removeEventListener("mousemove",ce),we.domElement.removeEventListener("mouseup",le),he.removeChild(we.domElement)},Pe.fen=function(){return Pe.position("fen")},Pe.flip=function(){return Pe.orientation("flip")},Pe.greySquare=function(e){Fe.push(Y(e,4210752)),je=!0},Pe.removeGreySquares=function(){for(;Fe.length>0;)ve.remove(Fe.pop());Fe=[],je=!0},Pe.move=function(){if(0!==arguments.length){for(var e=!0,o={},n=0;n<arguments.length;n++)if(arguments[n]!==!1)if(t(arguments[n])===!0){var r=arguments[n].split("-");o[r[0]]=r[1]}else c(2826,"Invalid move passed to the move method.",arguments[n]);else e=!1;var i=F(Je,o);return Pe.position(i,e),i}},Pe.orientation=function(e){return 0===arguments.length?Ve:"white"===e||"black"===e?(Ve=e,x("white"===e?Se:be),Ve):"flip"===e?(Ve="white"===Ve?"black":"white",x("white"===Ve?Se:be),Ve):void c(5482,"Invalid value passed to the orientation method.",e)},Pe.flip=function(){Pe.orientation("flip")},Pe.position=function(e,t){if(0===arguments.length)return o(Je);if("string"==typeof e&&"fen"===e.toLowerCase())return f(Je);if(t!==!1&&(t=!0),"string"==typeof e&&"start"===e.toLowerCase()&&(e=o(ge)),s(e)===!0&&(e=u(e)),p(e)!==!0)return void c(6482,"Invalid value passed to the position method.",e);var n=function(){if(t===!0&&void 0!==window.TWEEN&&"object"==typeof TWEEN){var o=W(Je,e);N(o,Je,e)}else X(e),Q(),je=!0};if(fe()&&Le===!1)n();else{var r=function(){fe()===!1||Le?setTimeout(r,100):n()};r()}},Pe.resize=function(){var e=he.clientWidth;e&=65532;var o=e*P;he.style.width=e,he.style.height=o,ye&&ye.updateProjectionMatrix(),we&&we.setSize(he.clientWidth,he.clientHeight),je=!0},Pe.start=function(e){Pe.position("start",e)},de(),Pe},window.ChessBoard3.webGLEnabled=e,window.ChessBoard3.fenToObj=u,window.ChessBoard3.objToFen=f}();